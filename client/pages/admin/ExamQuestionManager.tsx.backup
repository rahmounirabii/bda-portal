import { useState } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import {
  ArrowLeft,
  Plus,
  Edit,
  Trash2,
  Save,
  X,
  CheckCircle2,
  Circle,
  GraduationCap,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import {
  useExamAdmin,
  useCreateQuestion,
  useUpdateQuestion,
  useDeleteQuestion,
  useCreateAnswer,
  useUpdateAnswer,
  useDeleteAnswer,
} from '@/entities/mock-exam';
import type {
  CreateQuestionDTO,
  CreateAnswerDTO,
  ExamQuestionType,
  QuestionWithAnswers,
} from '@/entities/mock-exam/mock-exam.types';
import { useToast } from '@/hooks/use-toast';
import { useConfirm } from '@/contexts/ConfirmDialogContext';
import { cn } from '@/shared/utils/cn';

/**
 * ExamQuestionManager Page
 * Manage questions and answers for an exam
 */

export default function ExamQuestionManager() {
  const { examId } = useParams<{ examId: string }>();
  const navigate = useNavigate();
  const { toast } = useToast();
  const { confirm } = useConfirm();

  // Data fetching
  const { data: exam, isLoading } = useExamAdmin(examId || '');

  // Mutations
  const createQuestionMutation = useCreateQuestion();
  const updateQuestionMutation = useUpdateQuestion();
  const deleteQuestionMutation = useDeleteQuestion();
  const createAnswerMutation = useCreateAnswer();
  const updateAnswerMutation = useUpdateAnswer();
  const deleteAnswerMutation = useDeleteAnswer();

  // State for adding/editing question
  const [isAddingQuestion, setIsAddingQuestion] = useState(false);
  const [editingQuestionId, setEditingQuestionId] = useState<string | null>(null);
  const [questionForm, setQuestionForm] = useState<{
    question_text: string;
    question_text_ar: string;
    explanation: string;
    explanation_ar: string;
    question_type: ExamQuestionType;
    points: number;
    answers: Array<CreateAnswerDTO & { tempId: string }>;
  }>({
    question_text: '',
    question_text_ar: '',
    explanation: '',
    explanation_ar: '',
    question_type: 'single_choice',
    points: 1,
    answers: [],
  });

  const questions = exam?.questions || [];

  // Handlers
  const handleAddQuestion = () => {
    setIsAddingQuestion(true);
    setEditingQuestionId(null);
    setQuestionForm({
      question_text: '',
      question_text_ar: '',
      explanation: '',
      explanation_ar: '',
      question_type: 'single_choice',
      points: 1,
      answers: [
        { tempId: '1', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 0 },
        { tempId: '2', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 1 },
        { tempId: '3', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 2 },
        { tempId: '4', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 3 },
      ],
    });
  };

  const handleEditQuestion = (question: QuestionWithAnswers) => {
    setIsAddingQuestion(false);
    setEditingQuestionId(question.id);
    setQuestionForm({
      question_text: question.question_text,
      question_text_ar: question.question_text_ar || '',
      explanation: question.explanation || '',
      explanation_ar: question.explanation_ar || '',
      question_type: question.question_type,
      points: question.points,
      answers: question.answers.map((a, idx) => ({
        tempId: a.id,
        answer_text: a.answer_text,
        answer_text_ar: a.answer_text_ar || '',
        is_correct: a.is_correct,
        order_index: a.order_index,
      })),
    });
  };

  const handleCancelEdit = () => {
    setIsAddingQuestion(false);
    setEditingQuestionId(null);
  };

  const handleSaveQuestion = async () => {
    // Validation
    if (!questionForm.question_text.trim()) {
      toast({
        title: 'Validation Error',
        description: 'Question text is required',
        variant: 'destructive',
      });
      return;
    }

    if (questionForm.answers.length < 2) {
      toast({
        title: 'Validation Error',
        description: 'At least 2 answers are required',
        variant: 'destructive',
      });
      return;
    }

    const hasCorrectAnswer = questionForm.answers.some((a) => a.is_correct);
    if (!hasCorrectAnswer) {
      toast({
        title: 'Validation Error',
        description: 'At least one answer must be marked as correct',
        variant: 'destructive',
      });
      return;
    }

    if (questionForm.question_type === 'single_choice') {
      const correctCount = questionForm.answers.filter((a) => a.is_correct).length;
      if (correctCount !== 1) {
        toast({
          title: 'Validation Error',
          description: 'Single choice questions must have exactly one correct answer',
          variant: 'destructive',
        });
        return;
      }
    }

    try {
      if (isAddingQuestion) {
        // Create new question
        const dto: CreateQuestionDTO = {
          exam_id: examId!,
          question_text: questionForm.question_text,
          question_text_ar: questionForm.question_text_ar || undefined,
          explanation: questionForm.explanation || undefined,
          explanation_ar: questionForm.explanation_ar || undefined,
          question_type: questionForm.question_type,
          points: questionForm.points,
          order_index: questions.length,
          answers: questionForm.answers.map((a) => ({
            answer_text: a.answer_text,
            answer_text_ar: a.answer_text_ar || undefined,
            is_correct: a.is_correct,
            order_index: a.order_index,
          })),
        };

        const { error } = await createQuestionMutation.mutateAsync(dto);

        if (error) throw error;

        toast({
          title: 'Success',
          description: 'Question created successfully',
        });
      } else {
        // Update existing question
        const { error: questionError } = await updateQuestionMutation.mutateAsync({
          id: editingQuestionId!,
          question_text: questionForm.question_text,
          question_text_ar: questionForm.question_text_ar || undefined,
          explanation: questionForm.explanation || undefined,
          explanation_ar: questionForm.explanation_ar || undefined,
          question_type: questionForm.question_type,
          points: questionForm.points,
        });

        if (questionError) throw questionError;

        // Update answers
        // tempId is the real answer ID when editing (UUID format)
        // tempId is a timestamp when it's a new answer
        for (const answer of questionForm.answers) {
          const isExistingAnswer = answer.tempId.includes('-'); // UUID has dashes

          if (isExistingAnswer) {
            // Update existing answer
            const { error: answerError } = await updateAnswerMutation.mutateAsync({
              dto: {
                id: answer.tempId,
                answer_text: answer.answer_text,
                answer_text_ar: answer.answer_text_ar || undefined,
                is_correct: answer.is_correct,
                order_index: answer.order_index,
              },
              examId: examId!,
            });

            if (answerError) {
              console.error('Error updating answer:', answerError);
              throw answerError;
            }
          } else {
            // Create new answer
            const { error: answerError } = await createAnswerMutation.mutateAsync({
              questionId: editingQuestionId!,
              dto: {
                answer_text: answer.answer_text,
                answer_text_ar: answer.answer_text_ar || undefined,
                is_correct: answer.is_correct,
                order_index: answer.order_index,
              },
              examId: examId!,
            });

            if (answerError) {
              console.error('Error creating answer:', answerError);
              throw answerError;
            }
          }
        }

        toast({
          title: 'Success',
          description: 'Question updated successfully',
        });
      }

      handleCancelEdit();
    } catch (error) {
      console.error('Error saving question:', error);
      toast({
        title: 'Error',
        description: 'Failed to save question. Please try again.',
        variant: 'destructive',
      });
    }
  };

  const handleDeleteQuestion = async (questionId: string, questionText: string) => {
    const confirmed = await confirm({
      title: 'Delete Question',
      description: `Are you sure you want to delete this question: "${questionText}"? This will also delete all associated answers.`,
      confirmText: 'Delete',
      variant: 'destructive',
    });

    if (!confirmed) return;

    try {
      const { error } = await deleteQuestionMutation.mutateAsync({
        id: questionId,
        examId: examId!,
      });

      if (error) throw error;

      toast({
        title: 'Success',
        description: 'Question deleted successfully',
      });
    } catch (error) {
      console.error('Error deleting question:', error);
      toast({
        title: 'Error',
        description: 'Failed to delete question. Please try again.',
        variant: 'destructive',
      });
    }
  };

  const handleAddAnswer = () => {
    setQuestionForm((prev) => ({
      ...prev,
      answers: [
        ...prev.answers,
        {
          tempId: Date.now().toString(),
          answer_text: '',
          answer_text_ar: '',
          is_correct: false,
          order_index: prev.answers.length,
        },
      ],
    }));
  };

  const handleRemoveAnswer = (tempId: string) => {
    setQuestionForm((prev) => ({
      ...prev,
      answers: prev.answers.filter((a) => a.tempId !== tempId),
    }));
  };

  const handleUpdateAnswer = (tempId: string, field: keyof CreateAnswerDTO, value: any) => {
    setQuestionForm((prev) => ({
      ...prev,
      answers: prev.answers.map((a) =>
        a.tempId === tempId ? { ...a, [field]: value } : a
      ),
    }));
  };

  const handleToggleCorrect = (tempId: string) => {
    setQuestionForm((prev) => {
      const isSingleChoice = prev.question_type === 'single_choice';
      return {
        ...prev,
        answers: prev.answers.map((a) => {
          if (a.tempId === tempId) {
            return { ...a, is_correct: !a.is_correct };
          } else if (isSingleChoice) {
            // For single choice, uncheck other answers
            return { ...a, is_correct: false };
          }
          return a;
        }),
      };
    });
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="inline-block h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4" />
          <p className="text-gray-600">Loading exam...</p>
        </div>
      </div>
    );
  }

  if (!exam) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 mb-4">Exam not found</p>
          <Button onClick={() => navigate('/admin/exams')}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to Exams
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-6xl mx-auto">
      {/* Header */}
      <div className="bg-gradient-to-r from-sky-500 via-royal-600 to-navy-800 rounded-lg p-6 text-white">
        <div className="flex items-center gap-3">
          <Button
            variant="secondary"
            size="sm"
            onClick={() => navigate('/admin/exams')}
          >
            <ArrowLeft className="h-4 w-4" />
          </Button>
          <div className="flex-1">
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <GraduationCap className="h-8 w-8" />
              Question Manager
            </h1>
            <p className="mt-2 opacity-90">{exam.title}</p>
            <div className="mt-2 flex items-center gap-4 text-sm">
              <span>{questions.length} Questions</span>
              <span>•</span>
              <span>{exam.duration_minutes} minutes</span>
              <span>•</span>
              <span>Passing: {exam.passing_score}%</span>
            </div>
          </div>
          {!isAddingQuestion && !editingQuestionId && (
            <Button variant="secondary" size="sm" onClick={handleAddQuestion}>
              <Plus className="h-4 w-4 mr-2" />
              Add Question
            </Button>
          )}
        </div>
      </div>

      {/* Question Form (Add/Edit) */}
      {(isAddingQuestion || editingQuestionId) && (
        <Card className="border-2 border-blue-500">
          <CardHeader>
            <CardTitle className="flex items-center justify-between">
              <span>{isAddingQuestion ? 'Add New Question' : 'Edit Question'}</span>
              <Button variant="ghost" size="sm" onClick={handleCancelEdit}>
                <X className="h-4 w-4" />
              </Button>
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Question Text */}
            <div className="space-y-2">
              <Label>
                Question Text (English) <span className="text-red-500">*</span>
              </Label>
              <Textarea
                value={questionForm.question_text}
                onChange={(e) =>
                  setQuestionForm((prev) => ({ ...prev, question_text: e.target.value }))
                }
                placeholder="Enter question text in English"
                rows={3}
              />
            </div>

            <div className="space-y-2">
              <Label>Question Text (Arabic)</Label>
              <Textarea
                value={questionForm.question_text_ar}
                onChange={(e) =>
                  setQuestionForm((prev) => ({ ...prev, question_text_ar: e.target.value }))
                }
                placeholder="أدخل نص السؤال بالعربية"
                rows={3}
                dir="rtl"
              />
            </div>

            {/* Answer Selection Type */}
            <div className="space-y-4">
              <div className="space-y-3">
                <Label className="text-base font-semibold">Answer Selection Type</Label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {/* Single Answer Option */}
                  <button
                    type="button"
                    onClick={() => {
                      setQuestionForm((prev) => {
                        // When switching to single answer mode, keep only first correct answer
                        const correctAnswers = prev.answers.filter(a => a.is_correct);

                        if (correctAnswers.length > 1) {
                          toast({
                            title: 'Answers Auto-Corrected',
                            description: 'Only the first correct answer was kept. Single answer questions can only have one correct answer.',
                          });
                        }

                        const updatedAnswers = prev.answers.map((answer) => ({
                          ...answer,
                          is_correct: correctAnswers.length > 1
                            ? answer.tempId === correctAnswers[0].tempId // Keep only first correct
                            : answer.is_correct, // Keep as is if 0 or 1 correct
                        }));

                        return {
                          ...prev,
                          question_type: 'single_choice',
                          answers: prev.answers.length < 2 ? [
                            { tempId: '1', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 0 },
                            { tempId: '2', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 1 },
                          ] : updatedAnswers,
                        };
                      });
                    }}
                    className={cn(
                      'p-4 border-2 rounded-lg text-left transition-all',
                      questionForm.question_type === 'single_choice'
                        ? 'border-green-500 bg-green-50 shadow-md'
                        : 'border-gray-300 bg-white hover:border-green-300'
                    )}
                  >
                    <div className="flex items-start gap-3">
                      <div className="h-5 w-5 rounded-full border-2 border-green-600 flex items-center justify-center flex-shrink-0 mt-0.5">
                        {questionForm.question_type === 'single_choice' && (
                          <div className="h-2.5 w-2.5 rounded-full bg-green-600"></div>
                        )}
                      </div>
                      <div>
                        <h4 className="font-semibold text-gray-900">Single Answer</h4>
                        <p className="text-sm text-gray-600 mt-1">Only ONE correct answer (Radio buttons)</p>
                      </div>
                    </div>
                  </button>

                  {/* Multiple Answers Option */}
                  <button
                    type="button"
                    onClick={() => {
                      setQuestionForm((prev) => ({
                        ...prev,
                        question_type: 'multiple_choice',
                        answers: prev.answers.length < 2 ? [
                          { tempId: '1', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 0 },
                          { tempId: '2', answer_text: '', answer_text_ar: '', is_correct: false, order_index: 1 },
                        ] : prev.answers,
                      }));
                    }}
                    className={cn(
                      'p-4 border-2 rounded-lg text-left transition-all',
                      questionForm.question_type === 'multiple_choice'
                        ? 'border-blue-500 bg-blue-50 shadow-md'
                        : 'border-gray-300 bg-white hover:border-blue-300'
                    )}
                  >
                    <div className="flex items-start gap-3">
                      <div className="h-5 w-5 rounded border-2 border-blue-600 flex items-center justify-center flex-shrink-0 mt-0.5">
                        {questionForm.question_type === 'multiple_choice' && (
                          <CheckCircle2 className="h-3.5 w-3.5 text-blue-600" />
                        )}
                      </div>
                      <div>
                        <h4 className="font-semibold text-gray-900">Multiple Answers</h4>
                        <p className="text-sm text-gray-600 mt-1">MULTIPLE correct answers (Checkboxes)</p>
                      </div>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            {/* Points */}
            <div className="space-y-2">
              <Label>Points</Label>
                <Input
                  type="number"
                  min="1"
                  value={questionForm.points}
                  onChange={(e) =>
                    setQuestionForm((prev) => ({
                      ...prev,
                      points: parseInt(e.target.value) || 1,
                    }))
                  }
                />
              </div>
            </div>

            {/* Answers */}
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <Label className="text-lg">
                  Answers <span className="text-red-500">*</span>
                </Label>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={handleAddAnswer}
                >
                  <Plus className="h-4 w-4 mr-2" />
                  Add Answer
                </Button>
              </div>

              <div className="space-y-3">
                {questionForm.answers.map((answer, index) => (
                  <div
                    key={answer.tempId}
                    className={cn(
                      'p-4 border-2 rounded-lg',
                      answer.is_correct
                        ? 'border-green-500 bg-green-50'
                        : 'border-gray-200 bg-white'
                    )}
                  >
                    <div className="flex items-start gap-3">
                      <button
                        type="button"
                        onClick={() => handleToggleCorrect(answer.tempId)}
                        className="mt-3 focus:outline-none"
                      >
                        {answer.is_correct ? (
                          <CheckCircle2 className="h-6 w-6 text-green-600" />
                        ) : (
                          <Circle className="h-6 w-6 text-gray-400" />
                        )}
                      </button>
                      <div className="flex-1 space-y-3">
                        <Input
                          value={answer.answer_text}
                          onChange={(e) =>
                            handleUpdateAnswer(answer.tempId, 'answer_text', e.target.value)
                          }
                          placeholder={`Answer ${index + 1} (English)`}
                        />
                        <Input
                          value={answer.answer_text_ar}
                          onChange={(e) =>
                            handleUpdateAnswer(answer.tempId, 'answer_text_ar', e.target.value)
                          }
                          placeholder={`الإجابة ${index + 1} (عربي)`}
                          dir="rtl"
                        />
                      </div>
                      {questionForm.answers.length > 2 && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => handleRemoveAnswer(answer.tempId)}
                          className="mt-2"
                        >
                          <Trash2 className="h-4 w-4 text-red-600" />
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              <p className="text-sm text-gray-600">
                Click the circle icon to mark an answer as correct.
                {questionForm.question_type === 'single_choice'
                  ? ' (Only one can be correct for single choice)'
                  : ' (Multiple can be correct for multiple choice)'}
              </p>
            </div>

            {/* Explanation */}
            <div className="space-y-2">
              <Label>Explanation (English)</Label>
              <Textarea
                value={questionForm.explanation}
                onChange={(e) =>
                  setQuestionForm((prev) => ({ ...prev, explanation: e.target.value }))
                }
                placeholder="Optional explanation for the correct answer"
                rows={3}
              />
            </div>

            <div className="space-y-2">
              <Label>Explanation (Arabic)</Label>
              <Textarea
                value={questionForm.explanation_ar}
                onChange={(e) =>
                  setQuestionForm((prev) => ({ ...prev, explanation_ar: e.target.value }))
                }
                placeholder="شرح اختياري للإجابة الصحيحة"
                rows={3}
                dir="rtl"
              />
            </div>

            {/* Actions */}
            <div className="flex gap-3 justify-end pt-4 border-t">
              <Button variant="outline" onClick={handleCancelEdit}>
                Cancel
              </Button>
              <Button onClick={handleSaveQuestion}>
                <Save className="h-4 w-4 mr-2" />
                Save Question
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Questions List */}
      <Card>
        <CardHeader>
          <CardTitle>
            Questions ({questions.length})
          </CardTitle>
        </CardHeader>
        <CardContent>
          {questions.length === 0 ? (
            <div className="text-center py-12">
              <GraduationCap className="h-16 w-16 text-gray-300 mx-auto mb-4" />
              <p className="text-gray-600 mb-4">No questions yet</p>
              <Button onClick={handleAddQuestion} size="sm">
                <Plus className="h-4 w-4 mr-2" />
                Add First Question
              </Button>
            </div>
          ) : (
            <div className="space-y-4">
              {questions.map((question, index) => (
                <div
                  key={question.id}
                  className="border rounded-lg p-4 hover:border-blue-300 transition-colors"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-lg font-bold text-gray-900">
                          Q{index + 1}.
                        </span>
                        <Badge
                          variant={
                            question.question_type === 'single_choice'
                              ? 'default'
                              : 'secondary'
                          }
                        >
                          {question.question_type === 'single_choice'
                            ? 'Single Choice'
                            : 'Multiple Choice'}
                        </Badge>
                        <Badge variant="outline">{question.points} points</Badge>
                      </div>
                      <p className="text-gray-900 font-medium mb-3">
                        {question.question_text}
                      </p>
                      <div className="space-y-2">
                        {question.answers.map((answer) => (
                          <div
                            key={answer.id}
                            className={cn(
                              'flex items-center gap-2 p-2 rounded',
                              answer.is_correct
                                ? 'bg-green-50 text-green-900'
                                : 'bg-gray-50 text-gray-700'
                            )}
                          >
                            {answer.is_correct ? (
                              <CheckCircle2 className="h-4 w-4 text-green-600 flex-shrink-0" />
                            ) : (
                              <Circle className="h-4 w-4 text-gray-400 flex-shrink-0" />
                            )}
                            <span className="text-sm">{answer.answer_text}</span>
                          </div>
                        ))}
                      </div>
                      {question.explanation && (
                        <div className="mt-3 p-3 bg-blue-50 rounded text-sm text-blue-900">
                          <strong>Explanation:</strong> {question.explanation}
                        </div>
                      )}
                    </div>
                    <div className="flex gap-2 ml-4">
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => handleEditQuestion(question)}
                      >
                        <Edit className="h-4 w-4" />
                      </Button>
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() =>
                          handleDeleteQuestion(question.id, question.question_text)
                        }
                      >
                        <Trash2 className="h-4 w-4 text-red-600" />
                      </Button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

ExamQuestionManager.displayName = 'ExamQuestionManager';
